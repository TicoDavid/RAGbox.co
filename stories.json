{
  "project": "RAGbox.co",
  "version": "1.1.0",
  "description": "Secure RAG platform for compliance-sensitive SMBs on GCP - UPDATED with existing UI",
  "repository": "TicoDavid/RAGbox.co",
  "existing_codebase": {
    "note": "UI foundation already built - see RAGbox.co - Complete Codebase Outline",
    "implemented": [
      "Landing page UI (TheBox, PrivilegeCards)",
      "Dashboard Trinity layout (Sidebar, Vault, Mercury)",
      "Mercury chat UI with voice mode waveform",
      "LLM integration via OpenRouter",
      "File upload/display (mock data)",
      "Audio feedback (useRagSounds)",
      "Design system (Electric Blue, OLED Black)"
    ],
    "placeholders_to_migrate": [
      "Vector DB (Qdrant → AlloyDB + pgvector)",
      "LLM (OpenRouter → Vertex AI)",
      "Authentication (placeholder → Firebase)",
      "File storage (mock → Cloud Storage)"
    ]
  },
  "tech_stack": {
    "frontend": "Next.js 14 (App Router), React 18, Tailwind CSS, Framer Motion",
    "backend": "Node.js, TypeScript",
    "database": "AlloyDB with pgvector (migrating from Qdrant placeholder)",
    "ai": "Vertex AI (Gemini 1.5 Pro, text-embedding-004) - migrating from OpenRouter",
    "auth": "Firebase Authentication",
    "storage": "GCP Cloud Storage with CMEK",
    "infrastructure": "Cloud Run, Cloud Functions, Document AI"
  },
  "epics": [
    {
      "id": "E0",
      "name": "GCP Migration",
      "description": "Migrate existing codebase to GCP infrastructure"
    },
    {
      "id": "E1",
      "name": "Infrastructure Setup",
      "description": "GCP project, Terraform, CI/CD"
    },
    {
      "id": "E2",
      "name": "Authentication",
      "description": "Replace placeholder auth with Firebase"
    },
    {
      "id": "E3",
      "name": "Document Pipeline",
      "description": "Real file processing with Document AI and Cloud Storage"
    },
    {
      "id": "E4",
      "name": "RAG Engine",
      "description": "Migrate LLM to Vertex AI, implement full RAG pipeline with AlloyDB"
    },
    {
      "id": "E5",
      "name": "Privilege System",
      "description": "Implement actual privilege logic (UI exists)"
    },
    {
      "id": "E6",
      "name": "Audit System",
      "description": "Veritas audit logging to BigQuery"
    }
  ],
  "stories": [
    {
      "id": "S001",
      "epic": "E0",
      "title": "Audit Existing Codebase and Create Migration Plan",
      "status": "done",
      "priority": "critical",
      "story_points": 2,
      "description": "Review the existing RAGbox.co codebase and document what needs to be migrated to GCP.",
      "acceptance_criteria": [
        "Document all existing components and their status",
        "Identify OpenRouter → Vertex AI migration points",
        "Identify Qdrant → AlloyDB migration points",
        "Create GCP service mapping",
        "Update stories.json with accurate status"
      ],
      "files_to_create": [],
      "notes": "Completed via codebase outline review"
    },
    {
      "id": "S002",
      "epic": "E1",
      "title": "Set Up GCP Project and Enable APIs",
      "status": "done",
      "priority": "critical",
      "story_points": 3,
      "description": "Create GCP project and enable all required APIs for RAGbox.",
      "acceptance_criteria": [
        "GCP project created with billing enabled",
        "Enable APIs: Vertex AI, Document AI, Cloud Run, Cloud Storage, Cloud SQL, BigQuery, Secret Manager, Cloud KMS, Identity Platform",
        "Service account created with appropriate IAM roles",
        "Service account key downloaded for local development",
        ".env.local configured with GCP project details",
        "Test connection to each enabled service"
      ],
      "files_to_create": [
        "scripts/setup-gcp.sh",
        ".env.local.example"
      ]
    },
    {
      "id": "S003",
      "epic": "E1",
      "title": "Create Terraform Infrastructure",
      "status": "done",
      "priority": "high",
      "story_points": 5,
      "description": "Define infrastructure as code for reproducible GCP deployment.",
      "acceptance_criteria": [
        "Terraform configuration for Cloud Run service",
        "Cloud Storage bucket with CMEK encryption",
        "Cloud SQL PostgreSQL instance with pgvector",
        "Cloud KMS keyring and encryption key",
        "VPC network and connector for Cloud Run",
        "IAM bindings for service accounts",
        "Secret Manager secrets for credentials",
        "terraform init and plan run without errors"
      ],
      "files_to_create": [
        "terraform/main.tf",
        "terraform/variables.tf",
        "terraform/outputs.tf",
        "terraform/storage.tf",
        "terraform/database.tf",
        "terraform/cloudrun.tf",
        "terraform/kms.tf",
        "terraform/iam.tf",
        "terraform/README.md"
      ]
    },
    {
      "id": "S004",
      "epic": "E1",
      "title": "Configure Cloud Build CI/CD",
      "status": "done",
      "priority": "high",
      "story_points": 3,
      "description": "Set up automated deployment pipeline from GitHub to Cloud Run.",
      "acceptance_criteria": [
        "cloudbuild.yaml with build, test, deploy steps",
        "Dockerfile optimized for Cloud Run",
        "Cloud Build trigger connected to GitHub repo",
        "Secrets injected from Secret Manager",
        "Successful deployment on push to main"
      ],
      "files_to_create": [
        "cloudbuild.yaml",
        "Dockerfile"
      ],
      "notes": "May already have Dockerfile - update for GCP"
    },
    {
      "id": "S005",
      "epic": "E2",
      "title": "Implement Firebase Authentication",
      "status": "done",
      "priority": "critical",
      "story_points": 5,
      "description": "Replace placeholder auth with Firebase Authentication.",
      "acceptance_criteria": [
        "Firebase project created and linked to GCP project",
        "Firebase SDK initialized in existing codebase",
        "Update existing login/page.tsx with real Firebase auth",
        "Email/password authentication working",
        "Google OAuth working",
        "Microsoft OAuth working (for enterprise users)",
        "Auth state managed in AuthContext",
        "Protected routes redirect to login",
        "User session persisted across page refreshes"
      ],
      "files_to_modify": [
        "src/app/login/page.tsx",
        "src/components/providers/ThemeProvider.tsx"
      ],
      "files_to_create": [
        "src/lib/firebase.ts",
        "src/contexts/AuthContext.tsx",
        "src/middleware.ts"
      ]
    },
    {
      "id": "S006",
      "epic": "E3",
      "title": "Implement Cloud Storage File Upload",
      "status": "done",
      "priority": "critical",
      "story_points": 4,
      "description": "Replace mock file upload with real Cloud Storage integration.",
      "acceptance_criteria": [
        "Cloud Storage client configured with service account",
        "Update TheBox component to upload to Cloud Storage",
        "Files uploaded to user-specific path: gs://bucket/{user_id}/documents/",
        "Resumable uploads for large files (>5MB)",
        "Upload progress shown in existing UI",
        "File metadata stored (filename, size, type, timestamp)",
        "Signed URLs generated for secure file access",
        "useRagSounds drop sound triggered on successful upload"
      ],
      "files_to_modify": [
        "src/components/TheBox.tsx"
      ],
      "files_to_create": [
        "src/lib/gcp/storage.ts",
        "src/app/api/upload/route.ts"
      ]
    },
    {
      "id": "S007",
      "epic": "E3",
      "title": "Implement Document AI Text Extraction",
      "status": "done",
      "priority": "critical",
      "story_points": 5,
      "description": "Extract text from uploaded documents using Document AI.",
      "acceptance_criteria": [
        "Document AI processor created for general documents",
        "Cloud Function triggered on file upload to Cloud Storage",
        "PDF text extraction with page numbers preserved",
        "Image OCR for scanned documents",
        "Text chunking: 500 tokens with 50 token overlap",
        "Chunk metadata: source_file, page_number, chunk_index",
        "Extracted chunks stored in database",
        "Update ingestion log in UI with real processing status"
      ],
      "files_to_create": [
        "src/lib/gcp/documentai.ts",
        "src/lib/chunking.ts",
        "functions/processDocument/index.ts"
      ]
    },
    {
      "id": "S008",
      "epic": "E4",
      "title": "Set Up AlloyDB with pgvector",
      "status": "done",
      "priority": "critical",
      "story_points": 5,
      "description": "Replace Qdrant placeholder with AlloyDB PostgreSQL + pgvector.",
      "acceptance_criteria": [
        "AlloyDB instance provisioned (or Cloud SQL PostgreSQL for MVP)",
        "pgvector extension enabled",
        "Database schema: users, documents, chunks, embeddings tables",
        "Vector index created for similarity search (HNSW preferred)",
        "Prisma ORM configured with pgvector support",
        "Connection string stored in Secret Manager",
        "Migration scripts created",
        "Test data seeded for development"
      ],
      "files_to_create": [
        "prisma/schema.prisma",
        "prisma/migrations/init.sql",
        "src/lib/db.ts",
        "scripts/seed.ts"
      ]
    },
    {
      "id": "S009",
      "epic": "E4",
      "title": "Implement Vertex AI Embeddings",
      "status": "done",
      "priority": "critical",
      "story_points": 4,
      "description": "Generate vector embeddings using Vertex AI text-embedding-004.",
      "acceptance_criteria": [
        "Vertex AI client initialized",
        "text-embedding-004 model configured",
        "Batch embedding support (up to 250 texts per request)",
        "Embeddings stored in AlloyDB with pgvector",
        "Embedding generated after Document AI extraction",
        "API endpoint: POST /api/embed (internal)"
      ],
      "files_to_create": [
        "src/lib/gcp/vertexai.ts",
        "src/lib/embeddings.ts",
        "src/app/api/embed/route.ts"
      ]
    },
    {
      "id": "S010",
      "epic": "E4",
      "title": "Migrate LLM from OpenRouter to Vertex AI",
      "status": "done",
      "priority": "critical",
      "story_points": 5,
      "description": "Replace OpenRouter with Vertex AI Gemini 1.5 Pro for RAG generation.",
      "acceptance_criteria": [
        "Update src/lib/llm/provider.ts to support Vertex AI",
        "Create src/lib/llm/vertexai.ts provider",
        "Keep OpenRouter as fallback option",
        "Update /api/chat/route.ts to use new provider",
        "RAGBOX_SYSTEM_PROMPT preserved",
        "Streaming responses working",
        "Confidence scoring maintained"
      ],
      "files_to_modify": [
        "src/lib/llm/provider.ts",
        "src/lib/llm/index.ts",
        "src/app/api/chat/route.ts"
      ],
      "files_to_create": [
        "src/lib/llm/vertexai.ts"
      ]
    },
    {
      "id": "S011",
      "epic": "E4",
      "title": "Implement Full RAG Pipeline with Citations",
      "status": "done",
      "priority": "critical",
      "story_points": 8,
      "description": "Complete RAG pipeline: query → embed → retrieve → generate with citations.",
      "acceptance_criteria": [
        "Query embedding generated using same model as documents",
        "Vector similarity search in AlloyDB (top-k=10)",
        "Relevance reranking (optional cross-encoder)",
        "Context window assembled with retrieved chunks",
        "Prompt template includes system instructions + context + query",
        "Response includes inline citations [1], [2], [3]",
        "Citation metadata returned (filename, page, text snippet)",
        "Confidence score calculated per existing formula",
        "Mercury component displays citations correctly"
      ],
      "files_to_modify": [
        "src/components/Mercury.tsx"
      ],
      "files_to_create": [
        "src/lib/rag/pipeline.ts",
        "src/lib/rag/retrieval.ts",
        "src/lib/rag/generation.ts",
        "src/lib/rag/citations.ts"
      ]
    },
    {
      "id": "S012",
      "epic": "E4",
      "title": "Implement Silence Protocol",
      "status": "done",
      "priority": "critical",
      "story_points": 3,
      "description": "Refuse to answer when confidence is below 85% threshold.",
      "acceptance_criteria": [
        "Confidence threshold configurable (default 0.85)",
        "When confidence < threshold, return Silence Protocol message",
        "Message: 'I cannot provide a confident answer based on your documents...'",
        "Mercury displays response in warning style (amber color)",
        "Badge shows 'Low Confidence - Verify Source'",
        "Lock sound plays (useRagSounds)",
        "Audit log records Silence Protocol activation"
      ],
      "files_to_modify": [
        "src/components/Mercury.tsx"
      ],
      "files_to_create": [
        "src/lib/rag/silenceProtocol.ts"
      ]
    },
    {
      "id": "S013",
      "epic": "E5",
      "title": "Implement Privilege Toggle Backend Logic",
      "status": "done",
      "priority": "high",
      "story_points": 4,
      "description": "Connect existing privilege toggle UI to backend logic.",
      "acceptance_criteria": [
        "Privilege state stored in database per user",
        "Toggle state synced to backend on change",
        "When privileged mode ON: filter queries to only privileged documents",
        "When privileged mode OFF: include all documents",
        "Vault component filters document list based on mode",
        "Privilege change triggers lock sound",
        "Privilege change logged to audit trail"
      ],
      "files_to_modify": [
        "src/components/Vault.tsx",
        "src/lib/rag/retrieval.ts"
      ],
      "files_to_create": [
        "src/contexts/PrivilegeContext.tsx",
        "src/app/api/privilege/route.ts"
      ]
    },
    {
      "id": "S014",
      "epic": "E5",
      "title": "Implement Document Privilege Tagging",
      "status": "done",
      "priority": "high",
      "story_points": 3,
      "description": "Allow marking individual documents as privileged.",
      "acceptance_criteria": [
        "Each document has privilege flag in database",
        "Vault component shows privilege indicator (red lock icon)",
        "Toggle privilege via right-click context menu",
        "Privilege change confirmation dialog",
        "Cannot unmark privilege when in privileged mode (safety)",
        "Lock sound on privilege change"
      ],
      "files_to_modify": [
        "src/components/Vault.tsx"
      ],
      "files_to_create": [
        "src/app/api/documents/[id]/privilege/route.ts"
      ],
      "notes": "Full per-document privilege tagging with context menu, confirmation dialog, safety checks (cannot unmark in privileged mode), and API integration"
    },
    {
      "id": "S015",
      "epic": "E6",
      "title": "Implement Veritas Audit Logging",
      "status": "done",
      "priority": "critical",
      "story_points": 5,
      "description": "Create immutable audit trail of all system activities.",
      "acceptance_criteria": [
        "Audit events logged to Cloud Logging",
        "Events streamed to BigQuery for long-term storage",
        "Event types: upload, query, response, privilege_change, delete, login, silence_protocol",
        "Each event includes: timestamp, user_id, action, details_hash, IP address",
        "Response events include query hash for verification",
        "Logs are append-only (WORM-compatible)",
        "Retention policy: 7 years"
      ],
      "files_to_create": [
        "src/lib/audit/logger.ts",
        "src/lib/audit/types.ts",
        "src/lib/gcp/bigquery.ts"
      ],
      "notes": "Full audit system with Cloud Logging, BigQuery (7-year retention), and database logging; SHA-256 hash verification, convenience functions for all event types"
    },
    {
      "id": "S016",
      "epic": "E6",
      "title": "Build Audit Log Viewer Page",
      "status": "done",
      "priority": "high",
      "story_points": 4,
      "description": "Create UI for viewing audit trail (Truth & Audit nav item).",
      "acceptance_criteria": [
        "New page at /dashboard/audit",
        "Update Sidebar to link to audit page",
        "Timeline view styled like blockchain ledger",
        "Each entry shows: timestamp, user, action, details",
        "Filter by: date range, action type",
        "Search within audit entries",
        "Pagination for large datasets",
        "Entry detail modal with full information"
      ],
      "files_to_modify": [
        "src/components/Sidebar.tsx"
      ],
      "files_to_create": [
        "src/app/dashboard/audit/page.tsx",
        "src/components/audit/AuditTimeline.tsx",
        "src/components/audit/AuditEntry.tsx"
      ],
      "notes": "Full audit log viewer with blockchain-inspired timeline, filtering (action, severity, date range), search, pagination, and detail modal with integrity verification"
    },
    {
      "id": "S017",
      "epic": "E6",
      "title": "Implement Audit Report PDF Export",
      "status": "done",
      "priority": "medium",
      "story_points": 3,
      "description": "Export audit logs as watermarked PDF for regulators.",
      "acceptance_criteria": [
        "Export button: 'Print Official Ledger'",
        "PDF generated with audit entries for selected period",
        "Watermark: 'RAGbox Official Audit Report'",
        "Header: organization name, export date, user who exported",
        "Footer: page numbers, hash of report",
        "Download triggered in browser",
        "Export action logged to audit trail"
      ],
      "files_to_create": [
        "src/lib/audit/pdfExport.ts",
        "src/app/api/audit/export/route.ts"
      ],
      "notes": "Full PDF export with watermark, header/footer, SHA-256 hash verification, date filtering support, and audit logging of export action"
    },
    {
      "id": "S018",
      "epic": "E3",
      "title": "Update Vault to Show Real Documents",
      "status": "done",
      "priority": "high",
      "story_points": 3,
      "description": "Replace mock data in Vault with real documents from database.",
      "acceptance_criteria": [
        "Vault fetches documents from /api/documents",
        "Document list shows real files from Cloud Storage",
        "Each item shows: filename, type icon, size, upload date",
        "Privilege indicator reflects database state",
        "Sort and filter options work with real data",
        "Delete document removes from Cloud Storage and database"
      ],
      "files_to_modify": [
        "src/components/Vault.tsx"
      ],
      "files_to_create": [
        "src/app/api/documents/route.ts",
        "src/app/api/documents/[id]/route.ts",
        "src/hooks/useDocuments.ts"
      ],
      "notes": "Complete document management with API routes, useDocuments hook, loading/error states, file type icons, upload date display, and real document CRUD operations"
    },
    {
      "id": "S019",
      "epic": "E0",
      "title": "Implement One-Click Data Export",
      "status": "done",
      "priority": "medium",
      "story_points": 3,
      "description": "Allow users to export all their data (anti-lock-in).",
      "acceptance_criteria": [
        "Export button in Settings",
        "Export includes: all documents, metadata, query history",
        "Export format: ZIP file with folder structure",
        "Documents in original format",
        "Metadata in JSON",
        "Download link generated (signed URL, 24hr expiry)",
        "Export logged to audit trail"
      ],
      "files_to_create": [
        "src/app/dashboard/settings/page.tsx",
        "src/app/api/export/route.ts"
      ],
      "notes": "Full data export with settings page, ZIP archive format, document/query/profile export, manifest with SHA-256 hash, audit logging"
    },
    {
      "id": "S020",
      "epic": "E0",
      "title": "Implement Health Check and Monitoring",
      "status": "done",
      "priority": "medium",
      "story_points": 2,
      "description": "Add health check endpoint and basic monitoring.",
      "acceptance_criteria": [
        "GET /api/health returns system status",
        "Checks: database connection, Cloud Storage access, Vertex AI availability",
        "Returns 200 if healthy, 503 if degraded",
        "Cloud Run uses this for health checks",
        "Basic metrics logged to Cloud Monitoring"
      ],
      "files_to_create": [
        "src/app/api/health/route.ts"
      ],
      "notes": "Comprehensive health check with environment, database, Cloud Storage, Vertex AI, and memory checks; latency tracking, structured metrics logging, proper HTTP status codes"
    }
  ]
}
{
  "id": "S021",
  "epic": "E4",
  "title": "Integrate Mercury System Prompt and Output Firewall",
  "status": "todo",
  "priority": "critical",
  "story_points": 4,
  "description": "Integrate a production-grade Mercury system prompt and output firewall to enforce identity rules (Mercury only, no vendor names) and sanitize model outputs before they reach the user.",
  "acceptance_criteria": [
    "Create src/mercury/systemPrompt.ts defining MERCURY_SYSTEM_PROMPT with identity, safety, style and privilege instructions",
    "Create src/mercury/outputFirewall.ts implementing sanitizeMercuryOutput() with banned patterns for vendor names (ChatGPT, Claude, Gemini, etc.)",
    "Create src/mercury/outputFirewall.test.ts with unit tests verifying removal of vendor/model identity leakage",
    "Update src/app/api/chat/route.ts to prepend MERCURY_SYSTEM_PROMPT to every LLM request",
    "Update src/app/api/chat/route.ts to apply sanitizeMercuryOutput() on every model response including streaming",
    "Log firewall violations to Veritas audit but never expose in UI responses"
  ],
  "files_to_create": [
    "src/mercury/systemPrompt.ts",
    "src/mercury/outputFirewall.ts",
    "src/mercury/outputFirewall.test.ts"
  ],
  "files_to_modify": [
    "src/app/api/chat/route.ts"
  ]
},
{
  "id": "S022",
  "epic": "E1",
  "title": "Create /api/about Endpoint for Architecture Info",
  "status": "todo",
  "priority": "high",
  "story_points": 2,
  "description": "Add a static API route that returns a deterministic description of the RAGbox architecture without exposing vendor model identities.",
  "acceptance_criteria": [
    "Create src/app/api/about/route.ts returning JSON with name, identity, architecture, compliance, and policy fields",
    "Set runtime to 'edge' for fast global distribution",
    "Add Cache-Control header for 1-hour caching",
    "Ensure NO vendor model names appear (no Gemini, GPT, Claude, OpenAI, Anthropic)",
    "Add unit test verifying the endpoint returns expected structure"
  ],
  "files_to_create": [
    "src/app/api/about/route.ts"
  ],
  "files_to_modify": []
},
{
  "id": "S023",
  "epic": "E2",
  "title": "Fix Google OAuth Callback and NextAuth Configuration",
  "status": "todo",
  "priority": "critical",
  "story_points": 3,
  "description": "Resolve the Google OAuth callback error (404) and ensure NextAuth is correctly configured for both local development and Cloud Run deployment. BLOCKER - users cannot sign in.",
  "acceptance_criteria": [
    "Identify root cause of 404 on Google OAuth callback",
    "Update src/app/api/auth/[...nextauth]/route.ts to set trustHost: true",
    "Export both GET and POST handlers correctly for Next.js 14 App Router",
    "Update .env.local.example with NEXTAUTH_URL, NEXTAUTH_SECRET, GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET",
    "Document required Google Cloud Console redirect URIs in comments",
    "Add error handling to src/app/login/page.tsx with meaningful error messages"
  ],
  "files_to_create": [],
  "files_to_modify": [
    "src/app/api/auth/[...nextauth]/route.ts",
    "src/app/login/page.tsx",
    ".env.local.example"
  ]
},
{
  "id": "S024",
  "epic": "E4",
  "title": "Implement sanitizeForTTS and Improve Voice Chat Output",
  "status": "todo",
  "priority": "high",
  "story_points": 3,
  "description": "Improve text-to-speech by removing markdown artifacts and converting citations to speech-friendly phrases.",
  "acceptance_criteria": [
    "Create src/lib/tts/sanitize.ts with sanitizeForTTS() that strips markdown symbols and converts [1] to 'citation one'",
    "Create src/lib/tts/sanitize.test.ts with unit tests for headings, bold, code blocks, citations, lists",
    "Update src/components/Mercury.tsx to call sanitizeForTTS() before sending to TTS service",
    "Visual display keeps original markdown - only TTS output is sanitized"
  ],
  "files_to_create": [
    "src/lib/tts/sanitize.ts",
    "src/lib/tts/sanitize.test.ts"
  ],
  "files_to_modify": [
    "src/components/Mercury.tsx"
  ]
},
{
  "id": "S025",
  "epic": "E0",
  "title": "Unify Light/Dark Mode Theme Provider across UI",
  "status": "todo",
  "priority": "high",
  "story_points": 3,
  "description": "Eliminate theme inconsistencies by using next-themes with class strategy and ensuring all components respond uniformly to light/dark mode toggles.",
  "acceptance_criteria": [
    "Refactor src/components/providers/ThemeProvider.tsx to use next-themes with attribute='class' and defaultTheme='dark'",
    "Ensure tailwind.config.ts has darkMode: 'class'",
    "Remove redundant local theme state from components",
    "Update Sidebar, Vault, Mercury, Forge to use Tailwind dark: prefix classes",
    "Theme persists via localStorage through next-themes"
  ],
  "files_to_create": [],
  "files_to_modify": [
    "src/components/providers/ThemeProvider.tsx",
    "src/components/Sidebar.tsx",
    "src/components/Vault.tsx",
    "src/components/Mercury.tsx",
    "src/components/Forge.tsx",
    "tailwind.config.ts"
  ]
}