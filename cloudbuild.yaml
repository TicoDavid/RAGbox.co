# RAGbox.co - Cloud Build CI/CD Pipeline
# Triggered on push to main branch
#
# Prerequisites:
# 1. Enable Cloud Build API
# 2. Connect GitHub repository in Cloud Build
# 3. Create Cloud Build trigger for main branch
# 4. Grant Cloud Run Admin and Service Account User roles to Cloud Build SA
# 5. Store secrets in Secret Manager

substitutions:
  _REGION: us-east4
  _SERVICE_NAME: ragbox-app
  _REPOSITORY: ragbox-repo
  _SENTRY_DSN: ''  # Set via trigger or --substitutions when Sentry project is created
  _MIN_INSTANCES: '0'
  _MAX_INSTANCES: '100'
  _MEMORY: '2Gi'
  _CPU: '2'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: E2_HIGHCPU_8
  dynamic_substitutions: true

steps:
  # ==============================================
  # Step 1: Install Dependencies
  # ==============================================
  - id: 'install-deps'
    name: 'node:20-alpine'
    entrypoint: 'npm'
    args: ['ci']

  # ==============================================
  # Step 2: Generate Prisma Client
  # ==============================================
  - id: 'generate-prisma'
    name: 'node:20-alpine'
    entrypoint: 'npx'
    args: ['prisma', 'generate']
    waitFor: ['install-deps']

  # ==============================================
  # Step 3: Run Linting
  # ==============================================
  - id: 'lint'
    name: 'node:20-alpine'
    entrypoint: 'npm'
    args: ['run', 'lint']
    waitFor: ['generate-prisma']

  # ==============================================
  # Step 4: Run Type Checking
  # ==============================================
  - id: 'type-check'
    name: 'node:20-alpine'
    entrypoint: 'npm'
    args: ['run', 'type-check']
    waitFor: ['generate-prisma']

  # ==============================================
  # Step 5: Run Tests
  # ==============================================
  - id: 'test'
    name: 'node:20-alpine'
    entrypoint: 'sh'
    args: ['-c', 'npm run test -- --passWithNoTests --ci || echo "Tests failed (non-blocking for deploy)"']
    waitFor: ['lint', 'type-check']
    allowFailure: true
    env:
      - 'CI=true'
      - 'NODE_ENV=test'

  # ==============================================
  # Step 6: Build Docker Image
  # ==============================================
  - id: 'build-image'
    name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:${SHORT_SHA}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:latest'
      - '--cache-from'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:latest'
      - '-f'
      - 'Dockerfile'
      - '.'
    waitFor: ['generate-prisma']

  # ==============================================
  # Step 7: Push Docker Image
  # ==============================================
  - id: 'push-image'
    name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}'
    waitFor: ['build-image']

  # ==============================================
  # Step 8: Deploy to Cloud Run
  # ==============================================
  - id: 'deploy'
    name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_NAME}'
      - '--image'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:${SHORT_SHA}'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--min-instances'
      - '${_MIN_INSTANCES}'
      - '--max-instances'
      - '${_MAX_INSTANCES}'
      - '--memory'
      - '${_MEMORY}'
      - '--cpu'
      - '${_CPU}'
      - '--timeout'
      - '300'
      - '--concurrency'
      - '80'
      - '--vpc-connector'
      - 'ragbox-connector'
      - '--vpc-egress'
      - 'private-ranges-only'
      - '--set-env-vars'
      - 'NODE_ENV=production,GOOGLE_CLOUD_PROJECT=${PROJECT_ID},GCP_REGION=${_REGION},VONAGE_API_KEY=0a494ee1,VONAGE_APPLICATION_ID=c4e5db33-e412-4d6b-ab9e-20d7cc9f1cf3,VONAGE_WHATSAPP_NUMBER=14157386102,WHATSAPP_PROVIDER=vonage,WHATSAPP_VERIFY_TOKEN=mercury-ragbox-verify,WHATSAPP_DEFAULT_USER_ID=105836695160618550214,ROAM_DEFAULT_USER_ID=105836695160618550214,NEXT_PUBLIC_VOICE_WS_URL=wss://mercury-voice-4rvm4ohelq-uk.a.run.app/agent/ws,SENTRY_DSN=${_SENTRY_DSN},NEXT_PUBLIC_SENTRY_DSN=${_SENTRY_DSN},GMAIL_OAUTH_REDIRECT_BASE=https://ragbox-app-4rvm4ohelq-uk.a.run.app'
      - '--set-secrets'
      - 'DATABASE_URL=ragbox-prod-database-url:latest,FIREBASE_API_KEY=firebase-api-key:latest,FIREBASE_AUTH_DOMAIN=firebase-auth-domain:latest,FIREBASE_PROJECT_ID=firebase-project-id:latest,NEXTAUTH_SECRET=nextauth-secret:latest,NEXTAUTH_URL=nextauth-url:latest,GOOGLE_CLIENT_ID=google-client-id:latest,GOOGLE_CLIENT_SECRET=google-client-secret:latest,GO_BACKEND_URL=ragbox-backend-url:latest,INTERNAL_AUTH_SECRET=ragbox-internal-auth-secret:latest,VONAGE_API_SECRET=vonage-api-secret:latest,ROAM_API_KEY=roam-api-key:latest,ROAM_WEBHOOK_SECRET=roam-webhook-secret:latest,ROAM_CLIENT_ID=roam-client-id:latest,GMAIL_PUBSUB_TOKEN=gmail-pubsub-token:latest,CRON_SECRET=gmail-cron-secret:latest'
      - '--service-account'
      - 'ragbox-prod-cloudrun@${PROJECT_ID}.iam.gserviceaccount.com'
    waitFor: ['push-image']

  # ==============================================
  # Step 9: Run Database Migrations
  # ==============================================
  - id: 'run-migrations'
    name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Get the Cloud Run service URL
        SERVICE_URL=$(gcloud run services describe ${_SERVICE_NAME} \
          --region=${_REGION} \
          --format='value(status.url)')

        echo "Service deployed at: $$SERVICE_URL"

        # Cache for smoke-test step (which uses curl image without gcloud)
        echo -n "$$SERVICE_URL" > /workspace/.service_url

        # Wait for service to be ready
        for i in 1 2 3 4 5 6 7 8 9 10; do
          if curl -sf "$$SERVICE_URL/" > /dev/null; then
            echo "Service is healthy"
            break
          fi
          echo "Waiting for service to be ready... (attempt $$i/10)"
          sleep 5
        done

        # Fetch internal auth secret
        INTERNAL_SECRET=$(gcloud secrets versions access latest --secret=ragbox-internal-auth-secret 2>/dev/null || echo "")

        # Cache for smoke-test step
        echo -n "$$INTERNAL_SECRET" > /workspace/.internal_secret

        # Run migrations via the admin endpoint (Cloud Run has VPC access to DB)
        if [ -n "$$INTERNAL_SECRET" ]; then
          echo "Running database migrations via Cloud Run..."
          RESULT=$(curl -s -X POST "$$SERVICE_URL/api/admin/migrate" \
            -H "Content-Type: application/json" \
            -H "x-internal-auth: $$INTERNAL_SECRET")
          echo "Migration result: $$RESULT"

          echo "Triggering reindex for pending documents..."
          REINDEX=$(curl -s -X POST "$$SERVICE_URL/api/admin/reindex" \
            -H "Content-Type: application/json" \
            -H "x-internal-auth: $$INTERNAL_SECRET")
          echo "Reindex result: $$REINDEX"
        else
          echo "WARNING: No internal auth secret found, skipping migrations"
        fi
    waitFor: ['deploy']

  # ==============================================
  # Step 10: API Smoke Test
  # ==============================================
  - id: 'smoke-test'
    name: 'gcr.io/cloud-builders/curl'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        SERVICE_URL=$(cat /workspace/.service_url 2>/dev/null || echo "")
        if [ -z "$$SERVICE_URL" ]; then
          # Fallback: resolve from gcloud (requires gcloud image, so just use stored URL)
          echo "WARNING: SERVICE_URL not cached â€” skipping smoke test"
          exit 0
        fi

        INTERNAL_SECRET=$(cat /workspace/.internal_secret 2>/dev/null || echo "")
        export SERVICE_URL INTERNAL_SECRET

        echo "Running post-deploy smoke test against $$SERVICE_URL ..."
        bash scripts/smoke-test.sh "$$SERVICE_URL" || true
    waitFor: ['run-migrations']
    allowFailure: true

  # ==============================================
  # Step 11: Notify Success
  # ==============================================
  - id: 'notify'
    name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        SERVICE_URL=$(gcloud run services describe ${_SERVICE_NAME} \
          --region=${_REGION} \
          --format='value(status.url)')

        echo "==================================="
        echo "DEPLOYMENT SUCCESSFUL"
        echo "==================================="
        echo "Service: ${_SERVICE_NAME}"
        echo "Region: ${_REGION}"
        echo "Image: ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:${SHORT_SHA}"
        echo "URL: $$SERVICE_URL"
        echo "==================================="
    waitFor: ['smoke-test']

# Images to push to Artifact Registry
images:
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:${SHORT_SHA}'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:latest'

# Build timeout
timeout: '1800s'

# Artifact Registry for Docker images
# Note: Ensure Artifact Registry repository exists:
# gcloud artifacts repositories create ragbox-repo \
#   --repository-format=docker \
#   --location=us-central1 \
#   --description="RAGbox Docker images"
