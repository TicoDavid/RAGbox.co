// RAGbox.co - Prisma Schema
// PostgreSQL with pgvector extension for embeddings

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// ============================================
// User & Authentication
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  image     String?
  role      user_role @default(Associate)
  status    user_status @default(Active)
  subscriptionTier subscription_tier @default(free) @map("subscription_tier")
  subscriptionStatus subscription_status @default(inactive) @map("subscription_status")
  stripeCustomerId String? @unique @map("stripe_customer_id")
  stripeSubscriptionId String? @map("stripe_subscription_id")
  entitlements Json @default("{}") @map("entitlements")
  subscriptionStartedAt DateTime? @map("subscription_started_at")
  subscriptionEndsAt DateTime? @map("subscription_ends_at")
  privilegeModeEnabled Boolean @default(false) @map("privilege_mode_enabled")
  privilegeModeChangedAt DateTime? @map("privilege_mode_changed_at")
  onboardingCompleted Boolean @default(false) @map("onboarding_completed")
  companyName  String? @map("company_name")
  jobTitle     String? @map("job_title")
  industry     String? @map("industry")
  companySize  String? @map("company_size")
  useCase      String? @map("use_case")
  createdAt DateTime @default(now()) @map("created_at")
  lastLoginAt DateTime? @map("last_login_at")

  // Relations
  vaults    Vault[]
  documents Document[]
  queries   Query[]
  auditLogs AuditLog[]
  folders   Folder[]
  templates Template[]
  learningSessions LearningSession[]
  contentGaps      ContentGap[]
  whatsappContacts      WhatsAppContact[]
  whatsappConversations WhatsAppConversation[]
  integrationSettings   IntegrationSettings?
  mercuryThreads        MercuryThread[]
  mercuryActions        MercuryAction[]
  auditEntries          AuditEntry[]
  apiKeys               ApiKey[]
  knowledgeEvents       KnowledgeEvent[]
  notificationSettings  NotificationSettings?

  @@map("users")
}

enum user_role {
  Partner
  Associate
  Auditor
}

enum user_status {
  Active
  Suspended
}

enum subscription_tier {
  free
  sovereign
  mercury
  syndicate
}

enum subscription_status {
  inactive
  active
  past_due
  cancelled
}

// ============================================
// Beta Access Codes (Invite-Only Launch)
// ============================================

model BetaCode {
  id        String    @id @default(cuid())
  code      String    @unique
  batch     Int       // 1=David network, 2=inbound, 3=investor demos
  used      Boolean   @default(false)
  usedBy    String?   @map("used_by")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@map("beta_codes")
}

// ============================================
// Tenant (Multi-Tenant Isolation)
// ============================================

model Tenant {
  id        String   @id @default("default")
  name      String
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  persona   MercuryPersona?

  @@map("tenants")
}

// ============================================
// Mercury Persona (Tenant-Scoped AI Assistant)
// ============================================

model MercuryPersona {
  id                    String   @id @default(uuid())
  tenantId              String   @unique @map("tenant_id")
  firstName             String   @map("first_name")
  lastName              String   @default("") @map("last_name")
  title                 String?  @default("AI Assistant")
  personalityPrompt     String   @map("personality_prompt") @db.Text
  personalityPreset     String?  @map("personality_preset")
  rolePreset            String?  @map("role_preset")
  voiceId               String?  @map("voice_id")
  avatarUrl             String?  @map("avatar_url")
  greeting              String?
  signatureBlock        String?  @map("signature_block") @db.Text
  silenceHighThreshold  Float    @default(0.85) @map("silence_high_threshold")
  silenceMedThreshold   Float    @default(0.70) @map("silence_med_threshold")
  channelConfig         Json     @default("{}") @map("channel_config")
  isActive              Boolean  @default(true) @map("is_active")
  emailEnabled          Boolean  @default(false) @map("email_enabled")
  emailAddress          String?  @map("email_address")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@map("mercury_personas")
}

// ============================================
// Vault (Document Container)
// ============================================

model Vault {
  id               String   @id @default(cuid())
  name             String
  userId           String   @map("user_id")
  status           vault_status @default(open)
  documentCount    Int      @default(0) @map("document_count")
  storageUsedBytes BigInt   @default(0) @map("storage_used_bytes")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  user         User              @relation(fields: [userId], references: [id])
  documents    Document[]
  learningSessions LearningSession[]
  healthChecks     KBHealthCheck[]

  @@map("vaults")
}

enum vault_status {
  open
  closed
  secure
}

// ============================================
// Document
// ============================================

model Document {
  id              String         @id @default(cuid())
  tenantId        String         @default("default") @map("tenant_id")
  vaultId         String?        @map("vault_id")
  userId          String         @map("user_id")
  filename        String
  originalName    String         @map("original_name")
  mimeType        String         @map("mime_type")
  fileType        String         @map("file_type")
  sizeBytes       Int            @map("size_bytes")
  storageUri      String?        @map("storage_uri")
  storagePath     String?        @map("storage_path")
  extractedText   String?        @map("extracted_text")
  indexStatus     index_status    @default(Pending) @map("index_status")
  deletionStatus  deletion_status @default(Active) @map("deletion_status")
  isPrivileged    Boolean        @default(false) @map("is_privileged")
  privilegeLevel  String         @default("standard") @map("privilege_level") // standard | confidential | privileged
  isRestricted    Boolean        @default(false) @map("is_restricted")
  accessList      String[]       @default([]) @map("access_list")
  classifiedAt    DateTime?      @map("classified_at")
  classifiedBy    String?        @map("classified_by")
  securityTier    Int            @default(0) @map("security_tier")
  chunkCount      Int            @default(0) @map("chunk_count")
  isStarred       Boolean        @default(false) @map("is_starred")
  checksum        String?
  folderId        String?        @map("folder_id")
  sortOrder       Int            @default(0) @map("sort_order")
  metadata        Json?
  deletedAt       DateTime?      @map("deleted_at")
  hardDeleteAt    DateTime?      @map("hard_delete_at")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  vault    Vault?          @relation(fields: [vaultId], references: [id])
  user     User            @relation(fields: [userId], references: [id])
  folder   Folder?         @relation(fields: [folderId], references: [id])
  chunks   DocumentChunk[]
  citations Citation[]

  @@index([userId, deletionStatus])
  @@index([vaultId])
  @@index([securityTier])
  @@index([folderId])
  @@index([folderId, sortOrder])
  @@map("documents")
}

enum index_status {
  Pending
  Processing
  Indexed
  Failed
}

enum deletion_status {
  Active
  SoftDeleted
  HardDeleted
}

// ============================================
// Document Chunk (with pgvector embedding)
// ============================================

model DocumentChunk {
  id          String   @id @default(cuid())
  documentId  String   @map("document_id")
  chunkIndex  Int      @map("chunk_index")
  content     String
  contentHash String   @map("content_hash")
  tokenCount  Int      @default(0) @map("token_count")
  embedding   Unsupported("vector(768)")?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  document  Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  citations Citation[]

  @@index([documentId])
  @@map("document_chunks")
}

// ============================================
// Query & Answer
// ============================================

model Query {
  id              String       @id @default(cuid())
  userId          String       @map("user_id")
  queryText       String       @map("query_text")
  confidenceScore Float?       @map("confidence_score")
  outcome         query_outcome @default(Answered)
  privilegeMode   Boolean      @default(false) @map("privilege_mode")
  chunksUsed      Int          @default(0) @map("chunks_used")
  latencyMs       Int?         @map("latency_ms")
  model           String?
  createdAt       DateTime     @default(now()) @map("created_at")

  // Relations
  user    User     @relation(fields: [userId], references: [id])
  answer  Answer?

  @@index([userId])
  @@map("queries")
}

enum query_outcome {
  Answered
  Refused
}

model Answer {
  id         String   @id @default(cuid())
  queryId    String   @unique @map("query_id")
  answerText String   @map("answer_text")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  query     Query     @relation(fields: [queryId], references: [id], onDelete: Cascade)
  citations Citation[]

  @@map("answers")
}

// ============================================
// Citation
// ============================================

model Citation {
  id             String @id @default(cuid())
  answerId       String @map("answer_id")
  documentId     String @map("document_id")
  chunkId        String? @map("chunk_id")
  relevanceScore Float  @map("relevance_score")
  excerpt        String?
  citationIndex  Int    @map("citation_index")

  // Relations
  answer   Answer        @relation(fields: [answerId], references: [id], onDelete: Cascade)
  document Document      @relation(fields: [documentId], references: [id])
  chunk    DocumentChunk? @relation(fields: [chunkId], references: [id])

  @@map("citations")
}

// ============================================
// Audit Log
// DEPRECATED — do not write new entries here.
// Use AuditEntry (Go backend) for all new audit writes.
// ============================================

model AuditLog {
  id           String   @id @default(cuid())
  userId       String?  @map("user_id")
  action       String
  resourceId   String?  @map("resource_id")
  resourceType String?  @map("resource_type")
  severity     String   @default("INFO")
  details      Json?
  detailsHash  String?  @map("details_hash")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// Folder (for Drop Zone file explorer)
// ============================================

model Folder {
  id        String   @id @default(cuid())
  name      String
  userId    String   @map("user_id")
  parentId  String?  @map("parent_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user      User       @relation(fields: [userId], references: [id])
  parent    Folder?    @relation("FolderTree", fields: [parentId], references: [id])
  children  Folder[]   @relation("FolderTree")
  documents Document[]

  @@index([userId])
  @@index([parentId])
  @@map("folders")
}

// ============================================
// Template (FORGE system)
// ============================================

model Template {
  id          String   @id @default(cuid())
  name        String
  description String?
  userId      String   @default("system") @map("user_id")
  category    String?
  sections    Json?    // Template section definitions
  fields      Json?    // Template field definitions
  structure   Json?    // Document structure analysis
  confidence  Float?   @default(0.5) // Analysis confidence score
  sourceFile  String?  @map("source_file")
  storageUri  String?  @map("storage_uri")
  thumbnail   String?
  usageCount  Int      @default(0) @map("usage_count")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("templates")
}

// ============================================
// Learning Session (Content Intelligence)
// ============================================

model LearningSession {
  id               String          @id @default(cuid())
  userId           String          @map("user_id")
  vaultId          String          @map("vault_id")
  status           session_status  @default(active)
  topicsCovered    Json            @default("[]") @map("topics_covered")
  documentsQueried Json            @default("[]") @map("documents_queried")
  queryCount       Int             @default(0) @map("query_count")
  totalDurationMs  BigInt          @default(0) @map("total_duration_ms")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")

  // Relations
  user  User  @relation(fields: [userId], references: [id])
  vault Vault @relation(fields: [vaultId], references: [id])

  @@index([userId, status])
  @@index([vaultId])
  @@map("learning_sessions")
}

enum session_status {
  active
  paused
  completed
}

// ============================================
// Content Gap (Content Intelligence)
// ============================================

model ContentGap {
  id              String          @id @default(cuid())
  userId          String          @map("user_id")
  queryText       String          @map("query_text")
  confidenceScore Float           @map("confidence_score")
  suggestedTopics String[]        @map("suggested_topics")
  status          gap_status      @default(open)
  addressedAt     DateTime?       @map("addressed_at")
  createdAt       DateTime        @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId, status])
  @@map("content_gaps")
}

enum gap_status {
  open
  addressed
  dismissed
}

// ============================================
// KB Health Check (Content Intelligence)
// ============================================

model KBHealthCheck {
  id        String          @id @default(cuid())
  vaultId   String          @map("vault_id")
  checkType String          @map("check_type")
  status    health_status
  details   Json?
  runAt     DateTime        @default(now()) @map("run_at")

  // Relations
  vault Vault @relation(fields: [vaultId], references: [id])

  @@index([vaultId, checkType])
  @@map("kb_health_checks")
}

enum health_status {
  passed
  warning
  failed
}

// ============================================
// WhatsApp Integration
// ============================================

model WhatsAppContact {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  phoneNumber  String   @map("phone_number") // E.164 format
  displayName  String?  @map("display_name")
  isBlocked    Boolean  @default(false) @map("is_blocked")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user          User                  @relation(fields: [userId], references: [id])
  conversations WhatsAppConversation[]

  @@unique([userId, phoneNumber])
  @@index([userId])
  @@map("whatsapp_contacts")
}

model WhatsAppConversation {
  id              String                    @id @default(cuid())
  userId          String                    @map("user_id")
  contactId       String                    @map("contact_id")
  status          wa_conversation_status    @default(active)
  autoReply       Boolean                   @default(true) @map("auto_reply")
  unreadCount     Int                       @default(0) @map("unread_count")
  lastMessageText String?                   @map("last_message_text")
  lastMessageAt   DateTime?                 @map("last_message_at")
  createdAt       DateTime                  @default(now()) @map("created_at")
  updatedAt       DateTime                  @updatedAt @map("updated_at")

  // Relations
  user     User             @relation(fields: [userId], references: [id])
  contact  WhatsAppContact  @relation(fields: [contactId], references: [id])
  messages WhatsAppMessage[]

  @@unique([userId, contactId])
  @@index([userId, lastMessageAt(sort: Desc)])
  @@map("whatsapp_conversations")
}

model WhatsAppMessage {
  id                 String              @id @default(cuid())
  conversationId     String              @map("conversation_id")
  externalMessageId  String?             @map("external_message_id")
  direction          wa_direction
  messageType        wa_message_type     @default(text) @map("message_type")
  content            String?
  mediaUrl           String?             @map("media_url")
  status             wa_message_status   @default(sent)
  confidence         Float?              // RAG confidence for auto-replies
  queryId            String?             @map("query_id") // Link to RAG query
  createdAt          DateTime            @default(now()) @map("created_at")

  // Relations
  conversation WhatsAppConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([externalMessageId])
  @@map("whatsapp_messages")
}

enum wa_direction {
  inbound
  outbound
}

enum wa_message_type {
  text
  audio
  image
  document
  system
}

enum wa_message_status {
  sent
  delivered
  read
  failed
}

enum wa_conversation_status {
  active
  archived
  blocked
}

// ============================================
// Waitlist (Pioneer Program Signups)
// ============================================

model WaitlistEntry {
  id          String   @id @default(cuid())
  email       String   @unique
  fullName    String?  @map("full_name")
  company     String?
  role        String?
  companySize String?  @map("company_size")
  source      String?  // landing, blog, referral, etc.
  referrer    String?
  ipAddress   String?  @map("ip_address")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("waitlist_entries")
}

// ============================================
// Integration Settings
// ============================================

model IntegrationSettings {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")

  // WhatsApp
  whatsappEnabled       Boolean  @default(false) @map("whatsapp_enabled")
  whatsappProvider      String   @default("vonage") @map("whatsapp_provider")
  vonageApiKey          String?  @map("vonage_api_key")
  vonageApiSecret       String?  @map("vonage_api_secret")
  vonageApplicationId   String?  @map("vonage_application_id")
  vonageWhatsAppNumber  String?  @map("vonage_whatsapp_number")
  metaAccessToken       String?  @map("meta_access_token")
  metaPhoneNumberId     String?  @map("meta_phone_number_id")
  metaAppSecret         String?  @map("meta_app_secret")

  // Mercury
  mercuryVoiceEnabled   Boolean  @default(true) @map("mercury_voice_enabled")
  mercuryVoiceModel     String   @default("aura-asteria-en") @map("mercury_voice_model")
  mercuryAutoReply      Boolean  @default(true) @map("mercury_auto_reply")

  // Permissions
  whatsappAllowInbound  Boolean  @default(true) @map("whatsapp_allow_inbound")
  whatsappAllowOutbound Boolean  @default(true) @map("whatsapp_allow_outbound")
  whatsappAllowVoiceNotes Boolean @default(true) @map("whatsapp_allow_voice_notes")
  whatsappAllowedNumbers String[] @map("whatsapp_allowed_numbers")
  defaultVaultId        String?  @map("default_vault_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("integration_settings")
}

// ============================================
// ROAM Integration (Per-Tenant Credential Storage)
// ============================================

model RoamIntegration {
  id                    String    @id @default(cuid())
  tenantId              String    @unique @map("tenant_id")
  userId                String    @map("user_id")
  apiKeyEncrypted       String?   @map("api_key_encrypted") @db.Text
  webhookSubscriptionId String?   @map("webhook_subscription_id")
  targetGroupId         String?   @map("target_group_id")
  targetGroupName       String?   @map("target_group_name")
  mentionOnly           Boolean   @default(true) @map("mention_only")
  meetingSummaries       Boolean   @default(true) @map("meeting_summaries")
  status                String    @default("disconnected")
  connectedAt           DateTime? @map("connected_at")
  lastHealthCheckAt     DateTime? @map("last_health_check_at")
  errorReason           String?   @map("error_reason")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([targetGroupId])
  @@map("roam_integrations")
}

// ============================================
// ROAM Dead Letter Queue (Failed Event Replay)
// ============================================

model RoamDeadLetter {
  id              String    @id @default(cuid())
  tenantId        String    @map("tenant_id")
  pubsubMessageId String    @unique @map("pubsub_message_id")
  eventType       String    @map("event_type")
  payload         Json
  errorMessage    String    @map("error_message")
  errorStatus     Int?      @map("error_status")
  attemptCount    Int       @default(1) @map("attempt_count")
  retried         Boolean   @default(false)
  retriedAt       DateTime? @map("retried_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  @@index([tenantId, createdAt(sort: Desc)])
  @@index([retried])
  @@map("roam_dead_letters")
}

// ============================================
// Mercury Unified Thread
// ============================================

model MercuryThread {
  id        String   @id @default(cuid())
  tenantId  String   @default("default") @map("tenant_id")
  userId    String   @map("user_id")
  title     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user     User                  @relation(fields: [userId], references: [id])
  messages MercuryThreadMessage[]

  @@index([userId, updatedAt(sort: Desc)])
  @@map("mercury_threads")
}

model MercuryThreadMessage {
  id               String              @id @default(cuid())
  threadId         String              @map("thread_id")
  role             mercury_role
  channel          mercury_channel
  content          String
  confidence       Float?
  citations        Json?              // Citation[] serialized
  metadata         Json?              // Channel-specific metadata (whatsapp phone, voice session, etc.)
  channelMessageId String?            @map("channel_message_id") // external message ID (Vonage UUID, etc.)
  direction        String?            @default("inbound") // "inbound" | "outbound"
  createdAt        DateTime           @default(now()) @map("created_at")

  // Relations
  thread MercuryThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
  @@index([threadId, channel])
  @@map("mercury_thread_messages")
}

enum mercury_role {
  user
  assistant
}

enum mercury_channel {
  dashboard
  whatsapp
  voice
  roam
  email
  sms
}

// ============================================
// Mercury Actions (Email, SMS, WhatsApp audit)
// ============================================

model MercuryAction {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  agentId     String?  @map("agent_id")
  actionType  String   @map("action_type")
  recipient   String?
  subject     String?
  body        String?
  status      String   @default("completed")
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([actionType])
  @@index([createdAt])
  @@map("mercury_actions")
}

// ============================================
// Audit Entry (Hash-Chained, Tamper-Evident)
// ============================================

model AuditEntry {
  id           String   @id @default(cuid())
  tenantId     String   @default("default") @map("tenant_id")
  userId       String   @map("user_id")
  action       String   // document.upload | document.delete | document.classify | query.search | query.response | privilege.grant | privilege.revoke | export.compliance
  resourceId   String?  @map("resource_id")
  severity     String   @default("INFO")
  details      Json?
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  previousHash String?  @map("previous_hash")
  entryHash    String   @map("entry_hash") // SHA-256 of (previousHash + action + resourceId + details + timestamp)
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_entries")
}

// ============================================
// API Key (SHA-256 hashed, never stored raw)
// ============================================

model ApiKey {
  id        String    @id @default(cuid())
  tenantId  String    @default("default") @map("tenant_id")
  userId    String    @map("user_id")
  name      String
  keyPrefix String    @map("key_prefix")   // "rbx_live_" + first 8 chars
  keyHash   String    @unique @map("key_hash") // SHA-256 of full key
  scopes    String[]  @default(["read"])
  lastUsedAt DateTime? @map("last_used_at")
  expiresAt  DateTime? @map("expires_at")
  isRevoked  Boolean  @default(false) @map("is_revoked")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyHash])
  @@map("api_keys")
}

// ============================================
// Knowledge Event (Webhook Ingestion)
// ============================================

model KnowledgeEvent {
  id              String                 @id @default(cuid())
  tenantId        String                 @map("tenant_id")
  userId          String                 @map("user_id")
  eventId         String                 @map("event_id")
  sourceId        String                 @map("source_id")
  sourceName      String?                @map("source_name")
  title           String
  contentType     String                 @map("content_type")
  status          knowledge_event_status @default(received)
  documentId      String?                @map("document_id")
  privilegeLevel  String                 @default("standard") @map("privilege_level")
  tags            String[]               @default([])
  metadata        Json?
  expiresAt       DateTime?              @map("expires_at")
  callbackUrl     String?                @map("callback_url")
  errorDetails    String?                @map("error_details")
  processedAt     DateTime?              @map("processed_at")
  createdAt       DateTime               @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([tenantId, eventId])
  @@index([tenantId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@map("knowledge_events")
}

enum knowledge_event_status {
  received
  processing
  indexed
  failed
}

// ============================================
// LLM Config (BYOLLM — Tenant-Scoped)
// ============================================

model LLMConfig {
  id              String    @id @default(cuid())
  tenantId        String    @unique @map("tenant_id")
  provider        String    @default("openrouter")
  apiKeyEncrypted String    @map("api_key_encrypted") @db.Text
  baseUrl         String?   @map("base_url")
  defaultModel    String?   @map("default_model")
  policy          String    @default("choice")
  lastTestedAt    DateTime? @map("last_tested_at")
  lastTestResult  String?   @map("last_test_result")
  lastTestLatency Int?      @map("last_test_latency")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("llm_configs")
}

// ============================================
// Agent Email Credential (Per-Agent Gmail OAuth)
// ============================================

model AgentEmailCredential {
  id            String    @id @default(cuid())
  agentId       String    @unique @map("agent_id")
  emailAddress  String    @map("email_address")
  provider      String    @default("google")
  refreshToken  String    @map("refresh_token")
  scopes        String    @default("https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/gmail.send https://www.googleapis.com/auth/gmail.labels")
  isActive      Boolean   @default(true) @map("is_active")
  lastRefreshed DateTime? @map("last_refreshed")
  errorCount    Int       @default(0) @map("error_count")
  lastError     String?   @map("last_error")
  watchExpires  DateTime? @map("watch_expires")
  lastHistoryId String?   @map("last_history_id")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@index([emailAddress])
  @@map("agent_email_credentials")
}

// ============================================
// Notification Settings (Per-User Preferences)
// ============================================

model NotificationSettings {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  email     Boolean  @default(true)
  push      Boolean  @default(false)
  audit     Boolean  @default(true)
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_settings")
}
